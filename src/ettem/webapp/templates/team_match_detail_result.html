{% extends "base.html" %}

{% block title %}Resultado - {{ home_name }} vs {{ away_name }} - ETTEM{% endblock %}

{% block page_title %}{% if detail.status == 'completed' %}Editar Resultado{% else %}Ingresar Resultado{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="/team-match/{{ parent_match_id }}" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>Volver al Encuentro</span>
</a>
{% endblock %}

{% block content %}
<!-- Match Info Card -->
<div class="card mb-3">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title" style="margin: 0;">
            {{ team1_name }} vs {{ team2_name }} — Partido {{ detail.match_number }} de {{ total_matches }}
        </h3>
        {% if detail.match_type == 'doubles' %}
        <span class="badge badge-warning" style="font-size: 0.9rem; padding: 0.4rem 0.75rem;">DOBLES</span>
        {% endif %}
    </div>
    <div class="card-body">
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 1.25rem;">
            <div style="text-align: right; flex: 1;">
                <strong>{{ home_name }}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ detail.label_home }}</span>
            </div>
            <div style="font-size: 1.5rem; color: var(--text-muted);">VS</div>
            <div style="text-align: left; flex: 1;">
                <strong>{{ away_name }}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ detail.label_away }}</span>
            </div>
        </div>
    </div>
</div>

{% if detail.status == 'completed' %}
<div class="alert alert-warning mb-3">
    <span class="icon">⚠️</span>
    <div class="alert-content">
        <div class="alert-title">Editar Resultado</div>
        <div>Estás editando un resultado ya guardado. Los cambios reemplazarán el resultado anterior.</div>
    </div>
</div>
{% endif %}

<!-- Result Form Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Ingresar Sets (Mejor de {{ detail.best_of }})</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/team-match/{{ parent_match_id }}/detail/{{ detail.id }}/save-result" data-match-form>
            <div class="form-section">
                <div style="overflow-x: auto;">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th style="width: 180px;">Jugador</th>
                                {% for i in range(1, max_sets + 1) %}
                                <th style="width: 100px; text-align: center;">Set {{ i }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>{{ home_name }}</strong></td>
                                {% for i in range(1, max_sets + 1) %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p1"
                                           min="0"
                                           max="99"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 1 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if existing_sets|length >= i %}value="{{ existing_sets[i-1].player1_points }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>{{ away_name }}</strong></td>
                                {% for i in range(1, max_sets + 1) %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p2"
                                           min="0"
                                           max="99"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 2 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if existing_sets|length >= i %}value="{{ existing_sets[i-1].player2_points }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Walkover Section -->
            <div class="info-box info-box-warning" style="margin-top: 1.5rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; font-weight: 600; color: var(--warning); margin: 0;">
                        <input type="checkbox"
                               name="is_walkover"
                               value="true"
                               {% if detail.status == 'WALKOVER' %}checked{% endif %}
                               style="margin-right: 0.5rem; width: 18px; height: 18px;">
                        Walkover (W.O.)
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Ganador:</span>
                        <select name="winner_side" class="form-control" style="max-width: 300px; margin: 0;">
                            <option value="">- Seleccionar -</option>
                            <option value="1"
                                    {% if detail.winner_side == 1 %}selected{% endif %}>
                                {{ home_name }} ({{ team1_name }})
                            </option>
                            <option value="2"
                                    {% if detail.winner_side == 2 %}selected{% endif %}>
                                {{ away_name }} ({{ team2_name }})
                            </option>
                        </select>
                    </div>
                </div>
                <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                    Marca esta casilla si un jugador no se presentó. Selecciona al ganador y deja los sets vacíos.
                </p>
            </div>

            <!-- Instructions (collapsible) -->
            <details class="info-box info-box-info" style="margin-top: 1.5rem; padding: 0;">
                <summary style="padding: 1rem; cursor: pointer; font-weight: 600; color: var(--info); list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="details-arrow">&#9654;</span>
                    <span>ℹ️</span>
                    <span>Instrucciones</span>
                </summary>
                <style>
                details .details-arrow { transition: transform 0.2s; font-size: 0.8rem; }
                details[open] .details-arrow { transform: rotate(90deg); }
                </style>
                <ul style="margin: 0; padding: 0.5rem 1rem 1rem 2.5rem; color: var(--text-secondary);">
                    <li>Ingresa los puntos de cada set para ambos jugadores</li>
                    <li>Los sets se validan automáticamente (mínimo 11 puntos, diferencia de 2)</li>
                    <li>Mejor de {{ detail.best_of }} sets — gana el primero en alcanzar {{ (detail.best_of // 2) + 1 }} sets</li>
                    <li>Solo llena los sets jugados, deja los demás vacíos</li>
                </ul>
            </details>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var scoreInputs = document.querySelectorAll('.score-input');
                scoreInputs.forEach(function(input) {
                    input.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        if (this.value.length > 2) {
                            this.value = this.value.slice(0, 2);
                        }
                    });
                });
            });
            </script>

            <div class="d-flex gap-2" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">
                    <span>✓</span>
                    <span>Guardar Resultado</span>
                </button>
                <a href="/team-match/{{ parent_match_id }}" class="btn btn-secondary">
                    <span>✕</span>
                    <span>Cancelar</span>
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
