{% extends "base.html" %}

{% block title %}{% if match.status == 'pending' %}{{ t('matches.enter_result') }}{% else %}{{ t('matches.edit_result') }}{% endif %} - {{ t('app.short_title') }}{% endblock %}

{% block page_title %}{% if match.status == 'pending' %}{{ t('matches.enter_result') }}{% else %}{{ t('matches.edit_result') }}{% endif %}{% endblock %}

{% block topbar_actions %}
{% if match.group_id %}
<a href="/group/{{ match.group_id }}/matches" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>{{ t('common.cancel') }}</span>
</a>
{% else %}
<a href="/bracket/{{ category }}" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>{{ t('common.cancel') }}</span>
</a>
{% endif %}
{% endblock %}

{% block content %}
<!-- Match Info Card -->
<div class="card mb-3">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title" style="margin: 0;">{{ t('nav.matches') }}</h3>
        {% if table_number or scheduled_time %}
        <div style="display: flex; gap: 0.75rem;">
            {% if table_number %}
            <span class="badge badge-primary" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                {{ t('groups.table') }} {{ table_number }}
            </span>
            {% endif %}
            {% if scheduled_time %}
            <span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                {{ scheduled_time }}
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 1.25rem;">
            <div style="text-align: right; flex: 1;">
                <strong>{% if is_doubles %}{{ display1.full_name }}{% else %}{{ player1.nombre }} {{ player1.apellido }}{% endif %}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ display1.pais_cd }}</span>
            </div>
            <div style="font-size: 1.5rem; color: var(--text-muted);">VS</div>
            <div style="text-align: left; flex: 1;">
                <strong>{% if is_doubles %}{{ display2.full_name }}{% else %}{{ player2.nombre }} {{ player2.apellido }}{% endif %}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ display2.pais_cd }}</span>
            </div>
        </div>
    </div>
</div>

{% if match.status != 'pending' %}
<div class="alert alert-warning mb-3">
    <span class="icon">⚠️</span>
    <div class="alert-content">
        <div class="alert-title">{{ t('matches.edit_result') }}</div>
        <div>{{ t('matches.editing_warning') }}</div>
    </div>
</div>
{% endif %}

<!-- Result Form Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">{{ t('matches.enter_sets') }}</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/match/{{ match.id }}/save-result" data-match-form>
            {% if return_to %}
            <input type="hidden" name="return_to" value="{{ return_to }}">
            {% endif %}
            <div class="form-section">
                <!-- Horizontal Table Layout -->
                <div style="overflow-x: auto;">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th style="width: 180px;">{% if is_doubles %}Pareja{% else %}{{ t('standings.player') }}{% endif %}</th>
                                {% for i in range(1, best_of + 1) %}
                                <th style="width: 100px; text-align: center;">{{ t('matches.set_n', n=i) }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>{% if is_doubles %}{{ display1.nombre }} {{ display1.apellido }}{% else %}{{ player1.nombre[0] }}. {{ player1.apellido }}{% endif %}</strong></td>
                                {% for i in range(1, best_of + 1) %}
                                {% set set_data = match.sets[i-1] if match.sets and i <= match.sets|length else none %}
                                {# If form_values exists (validation error), use it; otherwise use saved set_data #}
                                {% if form_values %}
                                    {% set display_value = form_values.get('set' + i|string + '_p1', '') %}
                                {% else %}
                                    {% set display_value = set_data.player1_points if set_data else '' %}
                                {% endif %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p1"
                                           min="0"
                                           max="30"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 1 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if display_value != '' %}value="{{ display_value }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>{% if is_doubles %}{{ display2.nombre }} {{ display2.apellido }}{% else %}{{ player2.nombre[0] }}. {{ player2.apellido }}{% endif %}</strong></td>
                                {% for i in range(1, best_of + 1) %}
                                {% set set_data = match.sets[i-1] if match.sets and i <= match.sets|length else none %}
                                {# If form_values exists (validation error), use it; otherwise use saved set_data #}
                                {% if form_values %}
                                    {% set display_value = form_values.get('set' + i|string + '_p2', '') %}
                                {% else %}
                                    {% set display_value = set_data.player2_points if set_data else '' %}
                                {% endif %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p2"
                                           min="0"
                                           max="30"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 2 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if display_value != '' %}value="{{ display_value }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Walkover Section -->
            <div class="info-box info-box-warning" style="margin-top: 1.5rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; font-weight: 600; color: var(--warning); margin: 0;">
                        <input type="checkbox"
                               name="is_walkover"
                               value="true"
                               {% if match.status == 'WALKOVER' %}checked{% endif %}
                               style="margin-right: 0.5rem; width: 18px; height: 18px;">
                        {{ t('matches.walkover') }}
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">{{ t('matches.winner') }}:</span>
                        <select name="winner_id" class="form-control" style="max-width: 300px; margin: 0;">
                            <option value="">- {{ t('common.select') }} -</option>
                            <option value="{{ player1.id }}"
                                    {% if match.winner_id == player1.id %}selected{% endif %}>
                                {% if is_doubles %}{{ display1.full_name }}{% else %}{{ player1.nombre }} {{ player1.apellido }}{% endif %}
                            </option>
                            <option value="{{ player2.id }}"
                                    {% if match.winner_id == player2.id %}selected{% endif %}>
                                {% if is_doubles %}{{ display2.full_name }}{% else %}{{ player2.nombre }} {{ player2.apellido }}{% endif %}
                            </option>
                        </select>
                    </div>
                </div>
                <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
                    {{ t('matches.walkover_desc') }}
                </p>
            </div>

            <!-- Instructions (collapsible) -->
            <details class="info-box info-box-info" style="margin-top: 1.5rem; padding: 0;">
                <summary style="padding: 1rem; cursor: pointer; font-weight: 600; color: var(--info); list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="details-arrow">▶</span>
                    <span>ℹ️</span>
                    <span>{{ t('matches.instructions_title') }}</span>
                </summary>
                <style>
                details .details-arrow { transition: transform 0.2s; font-size: 0.8rem; }
                details[open] .details-arrow { transform: rotate(90deg); }
                </style>
                <ul style="margin: 0; padding: 0.5rem 1rem 1rem 2.5rem; color: var(--text-secondary);">
                    <li>{{ t('matches.instruction_1') }}</li>
                    <li>{{ t('matches.instruction_2') }}</li>
                    <li>{{ t('matches.instruction_3', best_of=best_of) }}</li>
                    <li>{{ t('matches.instruction_4') }}</li>
                </ul>
            </details>

            <script>
            // Limit score inputs to 2 digits
            document.addEventListener('DOMContentLoaded', function() {
                const scoreInputs = document.querySelectorAll('.score-input');
                scoreInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        // Only allow numbers
                        this.value = this.value.replace(/[^0-9]/g, '');
                        // Limit to 2 digits
                        if (this.value.length > 2) {
                            this.value = this.value.slice(0, 2);
                        }
                    });
                });
            });
            </script>

            <div class="d-flex gap-2" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">
                    <span>✓</span>
                    <span>{{ t('matches.save_result') }}</span>
                </button>
                {% if match.group_id %}
                <a href="/group/{{ match.group_id }}/matches" class="btn btn-secondary">
                    <span>✕</span>
                    <span>{{ t('common.cancel') }}</span>
                </a>
                {% else %}
                <a href="/bracket/{{ player1.categoria }}" class="btn btn-secondary">
                    <span>✕</span>
                    <span>{{ t('common.cancel') }}</span>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
