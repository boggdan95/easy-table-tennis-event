{% extends "base.html" %}

{% block title %}{% if match.status == 'pending' %}Ingresar{% else %}Editar{% endif %} Resultado - ETTEM{% endblock %}

{% block page_title %}{% if match.status == 'pending' %}Ingresar{% else %}Editar{% endif %} Resultado{% endblock %}

{% block topbar_actions %}
{% if match.group_id %}
<a href="/group/{{ match.group_id }}/matches" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>Cancelar</span>
</a>
{% else %}
<a href="/bracket/{{ player1.categoria }}" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>Cancelar</span>
</a>
{% endif %}
{% endblock %}

{% block content %}
<!-- Match Info Card -->
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Partido</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 1.25rem;">
            <div style="text-align: right; flex: 1;">
                <strong>{{ player1.nombre }} {{ player1.apellido }}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ player1.pais_cd }}</span>
            </div>
            <div style="font-size: 1.5rem; color: var(--text-muted);">VS</div>
            <div style="text-align: left; flex: 1;">
                <strong>{{ player2.nombre }} {{ player2.apellido }}</strong>
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ player2.pais_cd }}</span>
            </div>
        </div>
    </div>
</div>

{% if match.status != 'pending' %}
<div class="alert alert-warning mb-3">
    <span class="icon">⚠️</span>
    <div class="alert-content">
        <div class="alert-title">Editando Resultado</div>
        <div>Está editando un resultado existente. Los cambios sobrescribirán el resultado anterior.</div>
    </div>
</div>
{% endif %}

<!-- Result Form Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Ingresar Sets</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/match/{{ match.id }}/save-result" data-match-form>
            <div class="form-section">
                <!-- Horizontal Table Layout -->
                <div style="overflow-x: auto;">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th style="width: 180px;">Jugador</th>
                                <th style="width: 100px; text-align: center;">Set 1</th>
                                <th style="width: 100px; text-align: center;">Set 2</th>
                                <th style="width: 100px; text-align: center;">Set 3</th>
                                <th style="width: 100px; text-align: center;">Set 4</th>
                                <th style="width: 100px; text-align: center;">Set 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>{{ player1.nombre[0] }}. {{ player1.apellido }}</strong></td>
                                {% for i in range(1, 6) %}
                                {% set set_data = match.sets[i-1] if match.sets and i <= match.sets|length else none %}
                                {# If form_values exists (validation error), use it; otherwise use saved set_data #}
                                {% if form_values %}
                                    {% set display_value = form_values.get('set' + i|string + '_p1', '') %}
                                {% else %}
                                    {% set display_value = set_data.player1_points if set_data else '' %}
                                {% endif %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p1"
                                           min="0"
                                           max="99"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 1 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if display_value != '' %}value="{{ display_value }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>{{ player2.nombre[0] }}. {{ player2.apellido }}</strong></td>
                                {% for i in range(1, 6) %}
                                {% set set_data = match.sets[i-1] if match.sets and i <= match.sets|length else none %}
                                {# If form_values exists (validation error), use it; otherwise use saved set_data #}
                                {% if form_values %}
                                    {% set display_value = form_values.get('set' + i|string + '_p2', '') %}
                                {% else %}
                                    {% set display_value = set_data.player2_points if set_data else '' %}
                                {% endif %}
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="set{{ i }}_p2"
                                           min="0"
                                           max="99"
                                           class="form-control score-input"
                                           tabindex="{{ (i-1)*2 + 2 }}"
                                           style="width: 80px; margin: 0 auto; text-align: center;"
                                           placeholder="-"
                                           {% if display_value != '' %}value="{{ display_value }}"{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Walkover Section -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: #fff8e1; border-radius: 8px; border: 1px solid #ffe082;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; font-weight: 600; color: #f57c00; margin: 0;">
                        <input type="checkbox"
                               name="is_walkover"
                               value="true"
                               {% if match.status == 'WALKOVER' %}checked{% endif %}
                               style="margin-right: 0.5rem; width: 18px; height: 18px;">
                        Walkover (WO)
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #666;">Ganador:</span>
                        <select name="winner_id" class="form-control" style="max-width: 250px; margin: 0;">
                            <option value="">- Seleccionar -</option>
                            <option value="{{ player1.id }}"
                                    {% if match.winner_id == player1.id %}selected{% endif %}>
                                {{ player1.nombre }} {{ player1.apellido }}
                            </option>
                            <option value="{{ player2.id }}"
                                    {% if match.winner_id == player2.id %}selected{% endif %}>
                                {{ player2.nombre }} {{ player2.apellido }}
                            </option>
                        </select>
                    </div>
                </div>
                <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: #888;">
                    Marca esta casilla solo si un jugador no se presentó. Se asignará 3-0 automáticamente.
                </p>
            </div>

            <!-- Instructions (collapsible) -->
            <details style="margin-top: 1.5rem; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                <summary style="padding: 1rem; cursor: pointer; font-weight: 600; color: #1976d2; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="details-arrow">▶</span>
                    <span>ℹ️</span>
                    <span>Instrucciones</span>
                </summary>
                <style>
                details .details-arrow { transition: transform 0.2s; font-size: 0.8rem; }
                details[open] .details-arrow { transform: rotate(90deg); }
                </style>
                <ul style="margin: 0; padding: 0.5rem 1rem 1rem 2.5rem; color: #555;">
                    <li>Ingresa los puntos de cada set jugado</li>
                    <li>Deja vacíos los sets no jugados</li>
                    <li>El ganador se determina automáticamente (mejor de 5)</li>
                    <li>Regla deuce: a partir de 10-10, se necesitan 2 puntos de diferencia</li>
                </ul>
            </details>

            <script>
            // Limit score inputs to 2 digits
            document.addEventListener('DOMContentLoaded', function() {
                const scoreInputs = document.querySelectorAll('.score-input');
                scoreInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        // Only allow numbers
                        this.value = this.value.replace(/[^0-9]/g, '');
                        // Limit to 2 digits
                        if (this.value.length > 2) {
                            this.value = this.value.slice(0, 2);
                        }
                    });
                });
            });
            </script>

            <div class="d-flex gap-2" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">
                    <span>✓</span>
                    <span>Guardar Resultado</span>
                </button>
                {% if match.group_id %}
                <a href="/group/{{ match.group_id }}/matches" class="btn btn-secondary">
                    <span>✕</span>
                    <span>Cancelar</span>
                </a>
                {% else %}
                <a href="/bracket/{{ player1.categoria }}" class="btn btn-secondary">
                    <span>✕</span>
                    <span>Cancelar</span>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
