{% extends "base.html" %}

{% block title %}Resultados en Vivo - ETTEM{% endblock %}

{% block page_title %}Resultados en Vivo{% endblock %}

{% block topbar_actions %}
<a href="/" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>Volver al Inicio</span>
</a>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-warning">
    <span class="icon">‚ö†Ô∏è</span>
    <div class="alert-content">
        <div class="alert-title">{{ error }}</div>
    </div>
</div>
{% else %}

<!-- Header with filter and refresh -->
<div class="card mb-3">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 1.5rem;">‚ö°</span>
                <div>
                    <strong>Panel de Resultados en Vivo</strong>
                    <br>
                    <span style="color: var(--text-muted); font-size: 0.875rem;">Partidos agrupados por horario programado. Si ya completaste un slot posterior, los anteriores pendientes aparecen como retrasados.</span>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <form method="get" action="/admin/live-results" style="display: flex; gap: 0.5rem; align-items: center;">
                    <select name="category" class="form-control" style="width: auto;" onchange="this.form.submit()">
                        <option value="">Todas las categor√≠as</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </form>
                <a href="/admin/live-results{% if selected_category %}?category={{ selected_category }}{% endif %}" class="btn btn-secondary btn-sm" title="Refrescar">
                    <span>üîÑ</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="card mb-3">
    <div class="card-body" style="padding: 0.75rem 1rem;">
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.875rem;">
            <span><span class="badge badge-success">‚úÖ</span> Completado</span>
            <span><span class="badge badge-in-progress">üèì</span> En Juego</span>
            <span><span class="badge badge-warning">‚è≥</span> Pendiente</span>
            <span><span class="badge badge-danger">üî¥</span> Retrasado</span>
            <span><span style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 2px 8px; border-radius: 4px; border: 2px solid #2196F3;">Slot Actual</span></span>
        </div>
    </div>
</div>

<!-- Time Slots -->
{% if time_slots %}
<div class="time-slots-container">
    {% set current_session = namespace(id=None) %}
    {% for slot in time_slots %}
    {% if slot.status != 'completed' %}

    <!-- Session separator when session changes -->
    {% if slot.session_id != current_session.id %}
    {% set current_session.id = slot.session_id %}
    <div class="session-header mb-2 mt-3" style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0;">
        <div style="flex: 1; height: 2px; background: linear-gradient(90deg, var(--accent-color), var(--primary-color));"></div>
        <span style="font-weight: 600; color: var(--accent-color); font-size: 1rem; white-space: nowrap;">
            üìÖ {{ slot.session_name }}
        </span>
        <div style="flex: 1; height: 2px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color));"></div>
    </div>
    {% endif %}

    <div class="card mb-2 time-slot-card {% if slot.status == 'current' %}current-slot slot-open{% elif loop.index0 == current_slot_index %}slot-open{% endif %}" id="slot-{{ loop.index0 }}" style="overflow: hidden; {% if slot.status == 'current' %}border-left: 4px solid var(--info);{% elif slot.status == 'delayed' %}border-left: 4px solid var(--danger);{% endif %}">
        <div class="card-header" style="cursor: pointer; {% if slot.status == 'current' %}background: rgba(66, 153, 225, 0.15);{% elif slot.status == 'delayed' %}background: rgba(245, 101, 101, 0.15);{% endif %}" onclick="toggleSlot(this)">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="slot-arrow">‚ñ∂</span>
                    <span style="font-size: 1.25rem; font-weight: 600;">üïê {{ slot.time }}</span>
                    {% if slot.status == 'current' %}
                    <span class="badge badge-primary" style="animation: pulse 2s infinite;">EN JUEGO</span>
                    {% elif slot.status == 'delayed' %}
                    <span class="badge badge-danger">üî¥ RETRASADO</span>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <!-- Progress bar -->
                    <div style="width: 100px; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                        <div style="width: {{ (slot.completed / slot.total * 100) if slot.total > 0 else 0 }}%; height: 100%; background: {% if slot.completed == slot.total %}var(--success){% else %}var(--info){% endif %}; transition: width 0.3s;"></div>
                    </div>
                    <span class="badge {% if slot.completed == slot.total %}badge-success{% elif slot.completed > 0 %}badge-warning{% else %}badge-secondary{% endif %}">
                        {{ slot.completed }}/{{ slot.total }}
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body slot-content" style="padding: 0; {% if slot.status != 'current' and loop.index0 != current_slot_index %}display: none;{% endif %}">
            <div class="table-responsive">
                <table class="table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 60px; text-align: center;">Mesa</th>
                            <th style="width: 90px; text-align: center;">Cat/Grupo</th>
                            <th>Jugador 1</th>
                            <th style="width: 100px; text-align: center;">Resultado</th>
                            <th>Jugador 2</th>
                            <th style="width: 100px; text-align: center;">Estado</th>
                            <th style="width: 120px; text-align: center;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for md in slot.matches %}
                        {% set match = md.match %}
                        {% set p1 = md.player1 %}
                        {% set p2 = md.player2 %}
                        {% set group = md.group %}
                        {% set is_completed = match.status == 'completed' or match.status == 'WALKOVER' %}
                        {% set is_in_progress = match.status == 'in_progress' %}
                        <tr class="{% if is_completed %}row-completed{% endif %}" style="{% if not p1 or not p2 %}opacity: 0.7;{% elif slot.status == 'delayed' %}background: rgba(246, 173, 85, 0.15);{% endif %}">
                            <td style="text-align: center;">
                                <span class="badge badge-secondary" style="font-size: 1rem;">
                                    {{ md.schedule.table_number }}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    {% if md.is_bracket %}
                                    <span class="badge badge-info" style="font-size: 0.65rem;">{{ md.bracket_category }}</span>
                                    <span class="badge badge-success" style="font-size: 0.75rem;">üèÜ {{ md.bracket_round }}</span>
                                    {% else %}
                                    <span class="badge badge-warning" style="font-size: 0.65rem;">{{ group.category }}</span>
                                    <a href="/group/{{ group.id }}/matches" class="badge badge-primary" style="text-decoration: none;">
                                        G{{ group.name }}
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    {% if match.winner_id == p1.id %}<span style="color: var(--success);">üèÜ</span>{% endif %}
                                    {% if p1 %}
                                    <strong>{{ p1.nombre }} {{ p1.apellido }}</strong>
                                    <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ p1.pais_cd }}</span>
                                    {% else %}
                                    <span style="color: var(--text-muted);">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="text-align: center;">
                                {% if is_completed %}
                                <span class="badge {% if match.winner_id == p1.id %}badge-success{% else %}badge-danger{% endif %}" style="font-size: 0.9rem;">
                                    {{ match.player1_sets_won }}
                                </span>
                                <span style="margin: 0 4px;">-</span>
                                <span class="badge {% if match.winner_id == p2.id %}badge-success{% else %}badge-danger{% endif %}" style="font-size: 0.9rem;">
                                    {{ match.player2_sets_won }}
                                </span>
                                {% else %}
                                <span style="color: var(--text-muted);">vs</span>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                    {% if p2 %}
                                    <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ p2.pais_cd }}</span>
                                    <strong>{{ p2.nombre }} {{ p2.apellido }}</strong>
                                    {% if match.winner_id == p2.id %}<span style="color: var(--success);">üèÜ</span>{% endif %}
                                    {% else %}
                                    <span style="color: var(--text-muted);">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="text-align: center;">
                                {% if is_completed %}
                                <span class="badge badge-success">‚úÖ {{ t('matches.status.completed') }}</span>
                                {% elif is_in_progress %}
                                <span class="badge badge-in-progress">üèì {{ t('matches.status.in_progress') }}</span>
                                {% elif not p1 or not p2 %}
                                <span class="badge badge-secondary">‚è∏Ô∏è Esperando</span>
                                {% elif slot.status == 'delayed' %}
                                <span class="badge badge-danger">üî¥ Retrasado</span>
                                {% else %}
                                <span class="badge badge-secondary">{{ t('matches.status.pending') }}</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                {% if is_completed %}
                                <a href="/match/{{ match.id }}/enter-result?return_to=live" class="btn btn-secondary btn-sm" title="Editar resultado">
                                    <span>‚úèÔ∏è</span>
                                </a>
                                {% elif not p1 or not p2 %}
                                <span class="btn btn-secondary btn-sm" style="opacity: 0.5; cursor: not-allowed;" title="Esperando jugadores">
                                    <span>‚è∏Ô∏è</span>
                                </span>
                                {% else %}
                                <a href="/match/{{ match.id }}/enter-result?return_to=live" class="btn btn-primary btn-sm">
                                    <span>üìù</span>
                                    <span>Ingresar</span>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üìÖ</div>
        <h3 style="color: var(--text-muted);">No hay partidos programados</h3>
        <p style="color: var(--text-muted);">
            {% if selected_category %}
            No hay partidos programados para la categor√≠a {{ selected_category }}.
            {% else %}
            No hay partidos con horario asignado. Usa el programador (scheduler) para asignar horarios a los partidos.
            {% endif %}
        </p>
        <a href="/admin/scheduler" class="btn btn-primary" style="margin-top: 1rem;">
            <span>üìÖ</span>
            <span>Ir al Programador</span>
        </a>
    </div>
</div>
{% endif %}

<!-- Unscheduled matches section -->
{% if unscheduled %}
<div class="card mt-3">
    <div class="card-header" style="background: rgba(246, 173, 85, 0.15); cursor: pointer;" onclick="toggleUnscheduled()">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span class="unscheduled-arrow">‚ñ∂</span>
                <h3 class="card-title" style="margin: 0;">‚ö†Ô∏è Partidos sin programar</h3>
            </div>
            <span class="badge badge-warning">{{ unscheduled|length }}</span>
        </div>
    </div>
    <div class="card-body unscheduled-content" style="padding: 0; display: none;">
        <div class="table-responsive">
            <table class="table" style="margin: 0;">
                <thead>
                    <tr>
                        <th style="width: 90px; text-align: center;">Cat/Grupo</th>
                        <th>Jugador 1</th>
                        <th style="width: 100px; text-align: center;">vs</th>
                        <th>Jugador 2</th>
                        <th style="width: 100px; text-align: center;">Estado</th>
                        <th style="width: 120px; text-align: center;">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for md in unscheduled %}
                    {% set match = md.match %}
                    {% set p1 = md.player1 %}
                    {% set p2 = md.player2 %}
                    {% set group = md.group %}
                    {% set is_completed = match.status != 'pending' %}
                    <tr>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span class="badge badge-warning" style="font-size: 0.65rem;">{{ group.category }}</span>
                                <a href="/group/{{ group.id }}/matches" class="badge badge-primary" style="text-decoration: none;">
                                    G{{ group.name }}
                                </a>
                            </div>
                        </td>
                        <td>
                            <strong>{{ p1.nombre }} {{ p1.apellido }}</strong>
                            <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ p1.pais_cd }}</span>
                        </td>
                        <td style="text-align: center;">
                            {% if is_completed %}
                            <span class="badge {% if match.winner_id == p1.id %}badge-success{% else %}badge-danger{% endif %}">
                                {{ match.player1_sets_won }}
                            </span>
                            -
                            <span class="badge {% if match.winner_id == p2.id %}badge-success{% else %}badge-danger{% endif %}">
                                {{ match.player2_sets_won }}
                            </span>
                            {% else %}
                            vs
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ p2.pais_cd }}</span>
                            <strong>{{ p2.nombre }} {{ p2.apellido }}</strong>
                        </td>
                        <td style="text-align: center;">
                            {% if is_completed %}
                            <span class="badge badge-success">‚úÖ</span>
                            {% else %}
                            <span class="badge badge-secondary">Pendiente</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if is_completed %}
                            <a href="/match/{{ match.id }}/enter-result?return_to=live" class="btn btn-secondary btn-sm">
                                <span>‚úèÔ∏è</span>
                            </a>
                            {% else %}
                            <a href="/match/{{ match.id }}/enter-result?return_to=live" class="btn btn-primary btn-sm">
                                <span>üìù</span>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endif %}

<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .badge-in-progress {
        background-color: #0d6efd !important;
        color: white !important;
        animation: pulse 1.5s ease-in-out infinite;
    }

    .current-slot {
        box-shadow: 0 0 0 2px #2196F3, 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .slot-arrow, .unscheduled-arrow {
        transition: transform 0.2s;
        font-size: 0.8rem;
    }

    .slot-open .slot-arrow,
    .unscheduled-open .unscheduled-arrow {
        transform: rotate(90deg);
    }

    .time-slot-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
function toggleSlot(header) {
    const card = header.closest('.time-slot-card');
    const content = card.querySelector('.slot-content');
    const arrow = header.querySelector('.slot-arrow');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        card.classList.add('slot-open');
    } else {
        content.style.display = 'none';
        card.classList.remove('slot-open');
    }
}

function toggleUnscheduled() {
    const content = document.querySelector('.unscheduled-content');
    const card = content.closest('.card');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        card.classList.add('unscheduled-open');
    } else {
        content.style.display = 'none';
        card.classList.remove('unscheduled-open');
    }
}

// Auto-scroll to current slot
document.addEventListener('DOMContentLoaded', function() {
    const currentSlot = document.querySelector('.current-slot');
    if (currentSlot) {
        currentSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Mark open slots
    document.querySelectorAll('.slot-content').forEach(content => {
        if (content.style.display !== 'none') {
            content.closest('.time-slot-card').classList.add('slot-open');
        }
    });
});

// Auto-refresh every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
