{% extends "base.html" %}

{% block title %}KO Directo - ETTEM{% endblock %}

{% block page_title %}KO Directo (Bracket sin Grupos){% endblock %}

{% block topbar_actions %}
<a href="/" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>Volver al Inicio</span>
</a>
{% endblock %}

{% block content %}
<!-- Configuration Card -->
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">üéØ Bracket Eliminatorio Directo</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/admin/direct-bracket/preview" id="direct-bracket-form">
            <div class="grid grid-2 mb-3">
                <div class="form-section">
                    <label class="form-label">Categor√≠a *</label>
                    <select name="category" required class="form-control" id="category-select" onchange="updatePreview()">
                        <option value="">-Seleccionar Categor√≠a-</option>
                        {% for cat in available_categories %}
                        <option value="{{ cat.name }}"
                                data-count="{{ cat.count }}"
                                data-has-groups="{{ 'true' if cat.has_groups else 'false' }}"
                                data-has-bracket="{{ 'true' if cat.has_bracket else 'false' }}"
                                data-event-type="{{ cat.event_type }}"
                                {% if cat.has_bracket %}style="color: #ffc107;"{% endif %}>
                            {{ cat.name }} ({{ cat.count }} {% if cat.event_type == 'doubles' %}parejas{% else %}jugadores{% endif %}){% if cat.has_bracket %} ‚ö†Ô∏è tiene bracket{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-section">
                    <label class="form-label">Formato de Partidos</label>
                    <select name="best_of" class="form-control">
                        <option value="3">Mejor de 3 sets</option>
                        <option value="5" selected>Mejor de 5 sets</option>
                        <option value="7">Mejor de 7 sets</option>
                    </select>
                    <p class="form-help">Aplica a todos los partidos de la llave.</p>
                </div>
            </div>

            <div class="grid grid-2 mb-3">
                <div class="form-section">
                    <label class="form-label">Modo de Sorteo</label>
                    <select name="draw_mode" class="form-control" id="draw-mode-select" onchange="updateDrawMode()">
                        <option value="seeded">Seeding por ranking_pts</option>
                        <option value="random">Sorteo aleatorio</option>
                    </select>
                    <p class="form-help">Seeding ubica a los mejores en posiciones separadas. Sorteo es completamente al azar.</p>
                </div>
                <div class="form-section">
                    <label class="form-label">Semilla Aleatoria (Random Seed)</label>
                    <input type="number" name="random_seed" class="form-control" placeholder="42" value="42">
                    <p class="form-help">Para resultados reproducibles en el sorteo.</p>
                </div>
            </div>

            <!-- Dynamic warnings -->
            <div class="alert alert-warning mb-3" id="groups-warning" style="display: none;">
                <span class="icon">‚ö†Ô∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Grupos existentes</div>
                    <div>Esta categor√≠a tiene grupos creados. El KO Directo <strong>no usa</strong> los standings de grupo. Los competidores se seedean directamente por ranking_pts.</div>
                </div>
            </div>

            <div class="alert alert-warning mb-3" id="bracket-warning" style="display: none;">
                <span class="icon">‚ö†Ô∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Bracket existente</div>
                    <div>Esta categor√≠a ya tiene un bracket. Si contin√∫as, ser√° <strong>reemplazado</strong>.</div>
                </div>
            </div>

            <!-- Preview -->
            <div class="alert alert-info mb-3" id="preview-info" style="display: none;">
                <span class="icon">‚ÑπÔ∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Vista Previa</div>
                    <div id="preview-text"></div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <span>üéØ</span>
                    <span>Ver Sorteo</span>
                </button>
                <a href="/admin/generate-bracket" class="btn btn-secondary">
                    <span>üèÜ</span>
                    <span>Bracket desde Grupos</span>
                </a>
                <a href="/" class="btn btn-secondary">
                    <span>‚úï</span>
                    <span>Cancelar</span>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Competitors Preview Table -->
{% if available_categories %}
<div class="card" id="competitors-card" style="display: none;">
    <div class="card-header">
        <h3 class="card-title" id="competitors-title">Competidores</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Seed</th>
                        <th>Competidor</th>
                        <th>Pa√≠s</th>
                        <th>Ranking Pts</th>
                    </tr>
                </thead>
                <tbody id="competitors-body">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
// Competitors data passed from server
const competitorsByCategory = {{ competitors_json|safe }};

function updatePreview() {
    const select = document.getElementById('category-select');
    const option = select.options[select.selectedIndex];
    const previewInfo = document.getElementById('preview-info');
    const previewText = document.getElementById('preview-text');
    const groupsWarning = document.getElementById('groups-warning');
    const bracketWarning = document.getElementById('bracket-warning');
    const competitorsCard = document.getElementById('competitors-card');

    groupsWarning.style.display = 'none';
    bracketWarning.style.display = 'none';
    previewInfo.style.display = 'none';
    competitorsCard.style.display = 'none';

    if (!option.value) return;

    const count = parseInt(option.getAttribute('data-count'));
    const hasGroups = option.getAttribute('data-has-groups') === 'true';
    const hasBracket = option.getAttribute('data-has-bracket') === 'true';
    const eventType = option.getAttribute('data-event-type');

    if (hasGroups) groupsWarning.style.display = 'flex';
    if (hasBracket) bracketWarning.style.display = 'flex';

    const bracketSize = Math.pow(2, Math.ceil(Math.log2(count)));
    const byes = bracketSize - count;
    const unit = eventType === 'doubles' ? 'parejas' : 'jugadores';

    const drawMode = document.getElementById('draw-mode-select').value;
    let text = `${count} ${unit} ‚Üí bracket de ${bracketSize}`;
    if (byes > 0) text += ` con ${byes} BYE(s)`;
    text += drawMode === 'random' ? '. Sorteo aleatorio.' : '. Seeding por ranking_pts.';
    previewText.textContent = text;
    previewInfo.style.display = 'flex';

    // Show competitors table
    const competitors = competitorsByCategory[option.value] || [];
    if (competitors.length > 0) {
        const tbody = document.getElementById('competitors-body');
        tbody.innerHTML = '';
        competitors.forEach((c, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge badge-primary">${i + 1}</span></td>
                <td><strong>${c.name}</strong></td>
                <td><span class="badge badge-secondary">${c.country}</span></td>
                <td>${c.ranking_pts}</td>
            `;
            tbody.appendChild(tr);
        });
        const drawMode = document.getElementById('draw-mode-select').value;
        const titlePrefix = drawMode === 'random' ? 'Sorteo' : 'Seeding';
        document.getElementById('competitors-title').textContent = `${titlePrefix}: ${option.value} (${count} ${unit})`;
        competitorsCard.style.display = 'block';
    }
}

function updateDrawMode() {
    updatePreview();
}
</script>
{% endblock %}
