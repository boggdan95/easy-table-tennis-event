<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Llave - {{ category }}</title>
    <style>
        @page {
            size: letter portrait;
            margin: 1cm;
        }

        * { margin: 0; padding: 0; }

        body {
            font-family: Arial, sans-serif;
            font-size: 9pt;
            background-color: #ffffff;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .header h1 {
            font-size: 16pt;
            margin: 0 0 5px 0;
            color: #000000;
        }

        .header .subtitle {
            font-size: 10pt;
            color: #333333;
        }

        .header .champion {
            font-size: 12pt;
            font-weight: bold;
            margin-top: 5px;
            color: #1565c0;
        }

        /* Table-based bracket for xhtml2pdf compatibility */
        .bracket-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bracket-table th {
            background-color: #444444;
            color: #ffffff;
            padding: 6px 4px;
            font-size: 8pt;
            font-weight: bold;
            text-align: center;
            border: 1px solid #333333;
        }

        .bracket-table td {
            vertical-align: top;
            padding: 5px 3px;
            border: none;
        }

        .match {
            border: 1px solid #999999;
            margin-bottom: 8px;
            background-color: #ffffff;
        }

        .match-slot {
            padding: 4px 6px;
            font-size: 8pt;
            border-bottom: 1px solid #dddddd;
            min-height: 16px;
        }

        .match-slot-last {
            padding: 4px 6px;
            font-size: 8pt;
            min-height: 16px;
        }

        .match-slot-winner {
            padding: 4px 6px;
            font-size: 8pt;
            border-bottom: 1px solid #dddddd;
            min-height: 16px;
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .match-slot-winner-last {
            padding: 4px 6px;
            font-size: 8pt;
            min-height: 16px;
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .match-slot-loser {
            padding: 4px 6px;
            font-size: 8pt;
            border-bottom: 1px solid #dddddd;
            min-height: 16px;
            color: #888888;
        }

        .match-slot-loser-last {
            padding: 4px 6px;
            font-size: 8pt;
            min-height: 16px;
            color: #888888;
        }

        .match-slot-bye {
            padding: 4px 6px;
            font-size: 8pt;
            border-bottom: 1px solid #dddddd;
            min-height: 16px;
            color: #999999;
            font-style: italic;
            background-color: #fafafa;
        }

        .match-slot-bye-last {
            padding: 4px 6px;
            font-size: 8pt;
            min-height: 16px;
            color: #999999;
            font-style: italic;
            background-color: #fafafa;
        }

        .match-slot-tbd {
            padding: 4px 6px;
            font-size: 8pt;
            border-bottom: 1px solid #dddddd;
            min-height: 16px;
            color: #cccccc;
        }

        .match-slot-tbd-last {
            padding: 4px 6px;
            font-size: 8pt;
            min-height: 16px;
            color: #cccccc;
        }

        .slot-num {
            color: #666666;
            font-size: 7pt;
            display: inline-block;
            width: 16px;
        }

        .slot-score {
            float: right;
            font-weight: bold;
            color: #2e7d32;
        }

        .match-sets {
            background-color: #f5f5f5;
            font-size: 7pt;
            color: #666666;
            text-align: center;
            padding: 3px;
            border-top: 1px solid #dddddd;
        }

        .footer {
            margin-top: 15px;
            text-align: center;
            font-size: 8pt;
            color: #666666;
            border-top: 1px solid #cccccc;
            padding-top: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ tournament_name }}</h1>
        <div class="subtitle">{{ category }}{% if best_of %} - Mejor de {{ best_of }}{% endif %}</div>
        {% if champion %}
        <div class="champion">Campeon: {{ champion.nombre }} {{ champion.apellido }} ({{ champion.pais_cd }})</div>
        {% endif %}
    </div>

    <table class="bracket-table">
        <tr>
            {% for round_type in round_order %}
            <th>{{ round_names.get(round_type, round_type) }}</th>
            {% endfor %}
        </tr>
        <tr>
            {% for round_type in round_order %}
            <td>
                {% set slots = slots_by_round.get(round_type, []) %}
                {% for i in range(0, slots|length, 2) %}
                    {% set slot1 = slots[i] %}
                    {% set slot2 = slots[i+1] if i+1 < slots|length else None %}

                    {# Find match #}
                    {% set ns = namespace(match_data=None) %}
                    {% for m in matches_by_round.get(round_type, []) %}
                        {% if (m.player1 and slot1.player and m.player1.id == slot1.player.id) or
                              (m.player2 and slot1.player and m.player2.id == slot1.player.id) or
                              (slot1.slot.is_bye and slot2 and m.player2 and slot2.player and m.player2.id == slot2.player.id) %}
                            {% set ns.match_data = m %}
                        {% endif %}
                    {% endfor %}

                    {% set match_data = ns.match_data %}
                    {% set is_done = match_data and match_data.match.winner_id %}

                    <div class="match">
                        {# Player 1 #}
                        {% set w1 = slot1.player and match_data and match_data.match.winner_id == slot1.player.id %}
                        {% set l1 = slot1.player and match_data and match_data.match.winner_id and match_data.match.winner_id != slot1.player.id %}
                        {% set is_bye1 = slot1.slot.is_bye %}
                        {% set is_tbd1 = not slot1.player and not slot1.slot.is_bye %}

                        {% if w1 %}
                        <div class="match-slot-winner">
                        {% elif l1 %}
                        <div class="match-slot-loser">
                        {% elif is_bye1 %}
                        <div class="match-slot-bye">
                        {% elif is_tbd1 %}
                        <div class="match-slot-tbd">
                        {% else %}
                        <div class="match-slot">
                        {% endif %}
                            <span class="slot-num">{{ slot1.slot.slot_number }}</span>
                            {% if slot1.slot.is_bye %}BYE
                            {% elif slot1.player %}{{ slot1.player.apellido|upper }} {{ slot1.player.nombre[0] }}. ({{ slot1.player.pais_cd }})
                                {% if is_done %}
                                    <span class="slot-score">
                                        {% if match_data.player1 and match_data.player1.id == slot1.player.id %}{{ match_data.match.player1_sets_won }}
                                        {% elif match_data.player2 %}{{ match_data.match.player2_sets_won }}{% endif %}
                                    </span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </div>

                        {# Player 2 #}
                        {% if slot2 %}
                        {% set w2 = slot2.player and match_data and match_data.match.winner_id == slot2.player.id %}
                        {% set l2 = slot2.player and match_data and match_data.match.winner_id and match_data.match.winner_id != slot2.player.id %}
                        {% set is_bye2 = slot2.slot.is_bye %}
                        {% set is_tbd2 = not slot2.player and not slot2.slot.is_bye %}

                        {% if w2 %}
                        <div class="match-slot-winner-last">
                        {% elif l2 %}
                        <div class="match-slot-loser-last">
                        {% elif is_bye2 %}
                        <div class="match-slot-bye-last">
                        {% elif is_tbd2 %}
                        <div class="match-slot-tbd-last">
                        {% else %}
                        <div class="match-slot-last">
                        {% endif %}
                            <span class="slot-num">{{ slot2.slot.slot_number }}</span>
                            {% if slot2.slot.is_bye %}BYE
                            {% elif slot2.player %}{{ slot2.player.apellido|upper }} {{ slot2.player.nombre[0] }}. ({{ slot2.player.pais_cd }})
                                {% if is_done %}
                                    <span class="slot-score">
                                        {% if match_data.player1 and match_data.player1.id == slot2.player.id %}{{ match_data.match.player1_sets_won }}
                                        {% elif match_data.player2 %}{{ match_data.match.player2_sets_won }}{% endif %}
                                    </span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </div>
                        {% endif %}

                        {# Set scores #}
                        {% if is_done and match_data.match.sets %}
                        <div class="match-sets">
                            {% for s in match_data.match.sets %}{{ s.player1_points }}-{{ s.player2_points }}{% if not loop.last %} {% endif %}{% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </td>
            {% endfor %}
        </tr>
    </table>

    <div class="footer">
        ETTEM - {{ generation_date }}
    </div>
</body>
</html>
