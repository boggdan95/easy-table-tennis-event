{% extends "print/preview.html" %}

{% block extra_css %}
{{ super() }}
<style>
    /* Override preview page for landscape */
    .preview-page {
        max-width: 27.9cm; /* Letter height as width: 11in */
    }

    /* Bracket tree specific styles */
    .bracket-tree-preview {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 9pt;
    }

    .bracket-tree-preview .header {
        text-align: center;
        border-bottom: 2px solid #000;
        padding-bottom: 8px;
        margin-bottom: 12px;
    }

    .bracket-tree-preview .header h1 {
        font-size: 14pt;
        margin: 0 0 4px 0;
    }

    .bracket-tree-preview .header .subtitle {
        font-size: 10pt;
        color: #333;
    }

    .bracket-tree-preview table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .bracket-tree-preview th {
        background: #333;
        color: white;
        padding: 8px 4px;
        font-size: 9pt;
        text-align: center;
        border: 1px solid #333;
        text-transform: uppercase;
    }

    .bracket-tree-preview td {
        vertical-align: top;
        padding: 6px;
        border: 1px solid #ddd;
    }

    .bracket-tree-preview .match-box {
        border: 1px solid #000;
        margin-bottom: 8px;
        background: white;
    }

    .bracket-tree-preview .match-box.completed {
        border-color: #2d8a4e;
        border-width: 2px;
    }

    .bracket-tree-preview .player-row {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #ccc;
        padding: 0;
    }

    .bracket-tree-preview .player-row:last-of-type {
        border-bottom: none;
    }

    .bracket-tree-preview .player-row.winner {
        background: #e8f5e9;
        font-weight: bold;
    }

    .bracket-tree-preview .slot-num {
        width: 24px;
        background: #f0f0f0;
        text-align: center;
        font-weight: bold;
        font-size: 8pt;
        padding: 6px 2px;
        border-right: 1px solid #ccc;
        flex-shrink: 0;
    }

    .bracket-tree-preview .player-name-cell {
        flex: 1;
        padding: 6px 8px;
        font-size: 9pt;
    }

    .bracket-tree-preview .player-name-cell em {
        color: #666;
        font-style: italic;
    }

    .bracket-tree-preview .country-code {
        color: #666;
        font-size: 8pt;
    }

    .bracket-tree-preview .score-cell {
        width: 28px;
        text-align: center;
        font-weight: bold;
        font-size: 12pt;
        padding: 4px;
        background: #f5f5f5;
        border-left: 1px solid #ccc;
        flex-shrink: 0;
    }

    .bracket-tree-preview .player-row.winner .score-cell {
        background: #c8e6c9;
        color: #1b5e20;
    }

    .bracket-tree-preview .set-scores-row {
        background: #f9f9f9;
        padding: 4px 8px;
        text-align: center;
        font-size: 8pt;
        border-top: 1px solid #eee;
    }

    .bracket-tree-preview .set-score {
        display: inline-block;
        background: white;
        border: 1px solid #ccc;
        padding: 2px 5px;
        margin: 0 2px;
        border-radius: 3px;
        font-weight: 500;
    }

    .bracket-tree-preview .champion-badge {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #000;
        padding: 2px 8px;
        font-size: 8pt;
        font-weight: bold;
        border-radius: 4px;
        margin-left: 6px;
    }

    .bracket-tree-preview .spacer {
        height: 16px;
    }

    .bracket-tree-preview .legend {
        margin-top: 12px;
        font-size: 8pt;
        color: #666;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .bracket-tree-preview .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .bracket-tree-preview .legend-box {
        width: 14px;
        height: 14px;
        border: 1px solid #000;
    }

    .bracket-tree-preview .legend-box.winner {
        background: #e8f5e9;
        border-color: #2d8a4e;
    }

    .bracket-tree-preview .legend-box.completed {
        border-color: #2d8a4e;
        border-width: 2px;
    }

    .bracket-tree-preview .footer {
        margin-top: 12px;
        text-align: center;
        font-size: 8pt;
        color: #666;
        border-top: 1px solid #ccc;
        padding-top: 8px;
    }

    /* Print overrides */
    @media print {
        @page {
            size: letter landscape;
            margin: 0.5cm;
        }

        .preview-page {
            max-width: none !important;
        }
    }
</style>
{% endblock %}

{% block preview_content %}
<div class="preview-page landscape">
    <div class="bracket-tree-preview">
        <!-- Header -->
        <div class="header">
            <h1>{{ tournament_name }}</h1>
            <div class="subtitle">
                {% if category %}Categoria: {{ category }}{% endif %}
                {% if best_of %} | Mejor de {{ best_of }}{% endif %}
                {% if champion %} | CAMPEON: {{ champion.nombre }} {{ champion.apellido }} ({{ champion.pais_cd }}){% endif %}
            </div>
        </div>

        <!-- Bracket Table -->
        <table>
            <thead>
                <tr>
                    {% for round_type in round_order %}
                    <th>{{ round_names.get(round_type, round_type) }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    {% for round_type in round_order %}
                    <td>
                        {% set slots = slots_by_round.get(round_type, []) %}
                        {% for i in range(0, slots|length, 2) %}
                            {% set slot1 = slots[i] %}
                            {% set slot2 = slots[i+1] if i+1 < slots|length else None %}

                            {# Find match for this slot pair #}
                            {% set match_data = None %}
                            {% if matches_by_round.get(round_type) %}
                                {% for m in matches_by_round[round_type] %}
                                    {% if (m.player1 and slot1.player and m.player1.id == slot1.player.id) or
                                          (m.player2 and slot1.player and m.player2.id == slot1.player.id) %}
                                        {% set match_data = m %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}

                            <div class="match-box {% if match_data and match_data.match.winner_id %}completed{% endif %}">
                                {# Player 1 #}
                                <div class="player-row {% if slot1.player and match_data and match_data.match.winner_id == slot1.player.id %}winner{% endif %}">
                                    <span class="slot-num">{{ slot1.slot.slot_number }}</span>
                                    <span class="player-name-cell">
                                        {% if slot1.slot.is_bye %}
                                            <em>BYE</em>
                                        {% elif slot1.player %}
                                            {{ slot1.player.nombre }} {{ slot1.player.apellido }}
                                            <span class="country-code">({{ slot1.player.pais_cd }})</span>
                                            {% if champion and slot1.player.id == champion.id %}
                                                <span class="champion-badge">CAMPEON</span>
                                            {% endif %}
                                        {% else %}
                                            <em>-</em>
                                        {% endif %}
                                    </span>
                                    <span class="score-cell">
                                        {% if match_data and match_data.match.winner_id and slot1.player %}
                                            {% if match_data.player1 and match_data.player1.id == slot1.player.id %}
                                                {{ match_data.match.player1_sets_won }}
                                            {% elif match_data.player2 and match_data.player2.id == slot1.player.id %}
                                                {{ match_data.match.player2_sets_won }}
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>

                                {# Player 2 #}
                                {% if slot2 %}
                                <div class="player-row {% if slot2.player and match_data and match_data.match.winner_id == slot2.player.id %}winner{% endif %}">
                                    <span class="slot-num">{{ slot2.slot.slot_number }}</span>
                                    <span class="player-name-cell">
                                        {% if slot2.slot.is_bye %}
                                            <em>BYE</em>
                                        {% elif slot2.player %}
                                            {{ slot2.player.nombre }} {{ slot2.player.apellido }}
                                            <span class="country-code">({{ slot2.player.pais_cd }})</span>
                                            {% if champion and slot2.player.id == champion.id %}
                                                <span class="champion-badge">CAMPEON</span>
                                            {% endif %}
                                        {% else %}
                                            <em>-</em>
                                        {% endif %}
                                    </span>
                                    <span class="score-cell">
                                        {% if match_data and match_data.match.winner_id and slot2.player %}
                                            {% if match_data.player1 and match_data.player1.id == slot2.player.id %}
                                                {{ match_data.match.player1_sets_won }}
                                            {% elif match_data.player2 and match_data.player2.id == slot2.player.id %}
                                                {{ match_data.match.player2_sets_won }}
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}

                                {# Set scores #}
                                {% if match_data and match_data.match.winner_id and match_data.match.sets %}
                                <div class="set-scores-row">
                                    {% for set_obj in match_data.match.sets %}
                                        <span class="set-score">{{ set_obj.player1_points }}-{{ set_obj.player2_points }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            {# Add spacer for alignment between rounds #}
                            {% if loop.index < (slots|length / 2) %}
                            <div class="spacer"></div>
                            {% endif %}
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>

        <!-- Legend -->
        <div class="legend">
            <span class="legend-item"><span class="legend-box winner"></span> Ganador</span>
            <span class="legend-item"><span class="legend-box completed"></span> Completado</span>
            <span class="legend-item"><strong>#N</strong> = Posicion</span>
            <span class="legend-item"><strong>BYE</strong> = Pasa automaticamente</span>
        </div>

        <!-- Footer -->
        <div class="footer">
            ETTEM - Easy Table Tennis Event Manager | Generado: {{ generation_date }}
        </div>
    </div>
</div>
{% endblock %}
