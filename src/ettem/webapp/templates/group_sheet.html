{% extends "base.html" %}

{% block title %}{{ t('category.group') }} {{ group.name }} {{ category }} - {{ t('app.short_title') }}{% endblock %}

{% block page_title %}{{ t('category.group') }} {{ group.name }} - {{ category }}{% endblock %}

{% block topbar_actions %}
<a href="/category/{{ category }}" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>{{ t('common.back') }}</span>
</a>
{% endblock %}

{% block content %}
<!-- Navigation Card -->
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex gap-2">
            <a href="/group/{{ group.id }}/matches" class="btn btn-primary">
                <span>üìã</span>
                <span>{{ t('groups.view_match_list') }}</span>
            </a>
            <a href="/group/{{ group.id }}/standings" class="btn btn-success">
                <span>üìä</span>
                <span>{{ t('category.view_standings') }}</span>
            </a>
        </div>
    </div>
</div>

<!-- Play Order + Group Sheet Container -->
<div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">

<!-- Play Order Card -->
<div class="card" style="flex: 0 0 auto; min-width: 200px;">
    <div class="card-header">
        <h3 class="card-title">üìã {{ t('groups.play_order') }}</h3>
    </div>
    <div class="card-body" style="padding: 0.5rem;">
        <table class="play-order-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>{{ t('groups.match') }}</th>
                    <th>{{ t('groups.table') }}</th>
                    <th>{{ t('groups.time') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for match in play_order %}
                <tr class="{% if match.status == 'in_progress' %}match-in-progress{% elif match.status != 'pending' %}match-completed{% endif %}">
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ match.p1_num }}-{{ match.p2_num }}</strong></td>
                    <td>{% if match.table %}M{{ match.table }}{% else %}-{% endif %}</td>
                    <td>{% if match.time %}{{ match.time }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not play_order %}
        <p style="text-align: center; color: var(--text-muted); padding: 1rem;">{{ t('groups.no_matches') }}</p>
        {% endif %}
    </div>
</div>

<!-- Group Sheet Card -->
<div class="card" style="flex: 1 1 auto;">
    <div class="card-header">
        <h3 class="card-title">üìÑ {{ t('groups.results_matrix') }}</h3>
    </div>
    <div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="group-sheet-matrix">
    <thead>
        <tr>
            <th>{{ t('groups.position') }}</th>
            <th>{{ t('groups.player') }}</th>
            {% for p in players %}
            <th>{{ p.player.group_number }}</th>
            {% endfor %}
            <th>{{ t('groups.points') }}</th>
            <th>{{ t('groups.wins_losses') }}</th>
            <th>{{ t('matches.sets') }}</th>
            <th>{{ t('groups.points_detail') }}</th>
        </tr>
    </thead>
    <tbody>
        {% for p in players %}
        <tr>
            <td><strong>{{ p.player.group_number }}</strong></td>
            <td>{{ p.player.nombre }} {{ p.player.apellido }}</td>
            {% for opponent in players %}
                {% if p.player.id == opponent.player.id %}
                <td class="matrix-diagonal">X</td>
                {% else %}
                    {% set result = results_matrix.get(p.player.group_number, {}).get(opponent.player.group_number) %}
                    {% if result %}
                        {% if result == "WO" %}
                        <td class="matrix-wo">{{ result }}</td>
                        {% else %}
                        <td class="matrix-result">{{ result }}</td>
                        {% endif %}
                    {% else %}
                    <td class="matrix-pending">-</td>
                    {% endif %}
                {% endif %}
            {% endfor %}
            <td><strong>{{ p.standing.points_total if p.standing else 0 }}</strong></td>
            <td>{{ p.standing.wins if p.standing else 0 }}-{{ p.standing.losses if p.standing else 0 }}</td>
            <td>{{ p.standing.sets_w if p.standing else 0 }}-{{ p.standing.sets_l if p.standing else 0 }}</td>
            <td>{{ p.standing.points_w if p.standing else 0 }}-{{ p.standing.points_l if p.standing else 0 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
    </div>
    <div class="card-footer" style="margin-top: 1rem; border-top: 2px solid var(--border-color); padding-top: 1rem;">
        <details class="info-box info-box-info" style="padding: 0;">
            <summary style="padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; color: var(--info); list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                <span class="details-arrow">‚ñ∂</span>
                <span>‚ÑπÔ∏è</span>
                <span>{{ t('groups.matrix_note_title') }}</span>
            </summary>
            <ul style="margin: 0; padding: 0.5rem 1rem 1rem 2.5rem; color: var(--text-secondary); line-height: 1.8;">
                <li>{{ t('groups.matrix_note_1') }}</li>
                <li>{{ t('groups.matrix_note_2') }}</li>
                <li>{{ t('groups.matrix_note_3') }}</li>
                <li>{{ t('groups.matrix_note_4') }}</li>
            </ul>
        </details>
    </div>
</div>

</div> <!-- Close flex container -->

<style>
/* Play Order Table */
.play-order-table {
    width: 100%;
    border-collapse: collapse;
}

.play-order-table th,
.play-order-table td {
    border: 1px solid var(--border-color);
    padding: 6px 8px;
    text-align: center;
    font-size: 0.9rem;
}

.play-order-table th {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
    font-weight: 600;
    font-size: 0.8rem;
}

.play-order-table tbody tr:nth-child(even) {
    background-color: var(--bg-color);
}

.play-order-table tbody tr:hover {
    background-color: rgba(66, 153, 225, 0.1);
}

.play-order-table .match-completed {
    background-color: rgba(72, 187, 120, 0.15) !important;
    color: var(--success);
}

.play-order-table .match-completed td {
    text-decoration: line-through;
    opacity: 0.7;
}

@keyframes pulse-row {
    0%, 100% { background-color: rgba(13, 110, 253, 0.2); }
    50% { background-color: rgba(13, 110, 253, 0.35); }
}

.play-order-table .match-in-progress {
    animation: pulse-row 1.5s ease-in-out infinite;
}

.play-order-table .match-in-progress td {
    font-weight: 600;
    color: #0d6efd;
}

/* Group Sheet Matrix */
.group-sheet-matrix {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
}

.group-sheet-matrix th,
.group-sheet-matrix td {
    border: 1px solid var(--border-color);
    padding: 10px 8px;
    text-align: center;
}

.group-sheet-matrix th {
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
}

.group-sheet-matrix tbody tr:nth-child(even) {
    background-color: var(--bg-color);
}

.group-sheet-matrix tbody tr:hover {
    background-color: rgba(66, 153, 225, 0.1);
}

.matrix-diagonal {
    background: linear-gradient(135deg, #9E9E9E, #616161);
    color: white;
    font-weight: bold;
}

.matrix-result {
    background-color: rgba(72, 187, 120, 0.15);
    font-weight: bold;
    color: var(--success);
}

.matrix-wo {
    background-color: rgba(246, 173, 85, 0.2);
    font-weight: bold;
    color: var(--warning);
}

.matrix-pending {
    background-color: var(--bg-color);
    color: var(--text-muted);
}

.group-sheet-matrix td:first-child {
    background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), var(--card-bg));
    font-weight: bold;
    border-right: 2px solid var(--info);
}

.group-sheet-matrix td:nth-child(2) {
    text-align: left;
    white-space: nowrap;
}

/* Collapsible arrow */
details .details-arrow {
    transition: transform 0.2s;
    font-size: 0.8rem;
}
details[open] .details-arrow {
    transform: rotate(90deg);
}
</style>

<!-- Auto-refresh every 10 seconds for live updates -->
<script>
    setTimeout(function() {
        window.location.reload();
    }, 10000);
</script>
{% endblock %}
