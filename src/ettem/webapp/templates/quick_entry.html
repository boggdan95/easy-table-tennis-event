{% extends "base.html" %}

{% block title %}Entrada Rápida - Grupo {{ group.name }} - ETTEM{% endblock %}

{% block page_title %}Entrada Rápida - Grupo {{ group.name }}{% endblock %}

{% block topbar_actions %}
<a href="/group/{{ group.id }}/matches" class="btn btn-secondary btn-sm">
    <span>←</span>
    <span>Vista Normal</span>
</a>
{% endblock %}

{% block content %}
<!-- Info Card -->
<div class="card mb-3">
    <div class="card-body">
        <p style="margin: 0;">
            <strong>Modo de Entrada Rápida:</strong> Ingresa solo el marcador de sets (ejemplo: 3-1).
            Los puntos de cada set se generarán automáticamente (11-9, 11-8, etc.).
            Para ingresar puntos detallados, usa la vista normal.
        </p>
    </div>
</div>

<!-- Quick Entry Form -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Partidos Pendientes ({{ pending_matches|length }})</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if pending_matches %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Jugadores</th>
                        <th style="width: 200px; text-align: center;">Ganador</th>
                        <th style="width: 150px; text-align: center;">Score</th>
                        <th style="width: 100px; text-align: center;">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in pending_matches %}
                    <tr>
                        <td><span class="badge badge-secondary">{{ m.match.match_number }}</span></td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div>
                                    <strong>{{ m.player1.nombre }} {{ m.player1.apellido }}</strong>
                                    <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ m.player1.pais_cd }}</span>
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">vs</div>
                                <div>
                                    <strong>{{ m.player2.nombre }} {{ m.player2.apellido }}</strong>
                                    <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ m.player2.pais_cd }}</span>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <form id="form-{{ m.match.id }}" class="quick-entry-form" data-match-id="{{ m.match.id }}">
                                <select name="winner" class="form-control" required style="font-size: 0.9rem;">
                                    <option value="">Seleccionar ganador...</option>
                                    <option value="{{ m.player1.id }}">{{ m.player1.apellido }}</option>
                                    <option value="{{ m.player2.id }}">{{ m.player2.apellido }}</option>
                                    <option value="WO-{{ m.player1.id }}">{{ m.player1.apellido }} (WO)</option>
                                    <option value="WO-{{ m.player2.id }}">{{ m.player2.apellido }} (WO)</option>
                                </select>
                            </form>
                        </td>
                        <td style="text-align: center;">
                            <select form="form-{{ m.match.id }}" name="score" class="form-control" required style="font-size: 0.9rem;">
                                <option value="">-</option>
                                <option value="3-0">3-0</option>
                                <option value="3-1">3-1</option>
                                <option value="3-2">3-2</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <button type="submit"
                                    form="form-{{ m.match.id }}"
                                    class="btn btn-success btn-sm"
                                    style="width: 100%;">
                                Guardar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
            <p style="font-size: 1.25rem; margin-bottom: 1rem;">✓ Todos los partidos han sido completados</p>
            <a href="/group/{{ group.id }}/standings" class="btn btn-primary">Ver Clasificación</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Handle quick entry form submissions
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.quick-entry-form');

    forms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const matchId = form.dataset.matchId;
            const formData = new FormData(form);
            const winner = formData.get('winner');
            const score = formData.get('score');

            if (!winner || !score) {
                showToast('Por favor selecciona ganador y score', 'warning');
                return;
            }

            // Check if it's a walkover
            const isWalkover = winner.startsWith('WO-');
            const winnerId = isWalkover ? winner.substring(3) : winner;

            try {
                // Disable form while submitting
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = '...';

                const response = await fetch(`/match/${matchId}/quick-save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        winner_id: winnerId,
                        score: score,
                        is_walkover: isWalkover
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || 'Resultado guardado', 'success');
                    // Remove row from table
                    form.closest('tr').remove();

                    // Update pending count
                    const remainingRows = document.querySelectorAll('.quick-entry-form').length;
                    const headerTitle = document.querySelector('.card-title');
                    if (remainingRows === 0) {
                        // Reload to show completion message
                        window.location.reload();
                    } else {
                        headerTitle.textContent = `Partidos Pendientes (${remainingRows})`;
                    }
                } else {
                    showToast(result.error || 'Error al guardar', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                showToast('Error de conexión', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    });
});
</script>
{% endblock %}
