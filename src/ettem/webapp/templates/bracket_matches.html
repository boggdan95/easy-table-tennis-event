{% extends "base.html" %}
{% from "_macros.html" import cc_badge with context %}

{% block title %}{{ t('nav.bracket') }} {{ category }} - {{ t('app.short_title') }}{% endblock %}

{% block page_title %}{{ t('nav.bracket') }} - {{ category }}{% endblock %}

{% block topbar_actions %}
<a href="/category/{{ category }}/bracket" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>{{ t('bracket.visual_bracket') }}</span>
</a>
{% if has_groups %}
<a href="/category/{{ category }}" class="btn btn-outline btn-sm">
    <span>üë•</span>
    <span>{{ t('nav.groups') }}</span>
</a>
{% endif %}
{% if pending_byes is defined and pending_byes > 0 %}
<button onclick="confirmProcessByes('{{ category }}', {{ pending_byes }})" class="btn btn-primary btn-sm" title="{{ t('bracket.process_byes') }}">
    <span>‚è©</span>
    <span>{{ t('bracket.process_byes') }} ({{ pending_byes }})</span>
</button>
{% endif %}
<a href="/category/{{ category }}/results" class="btn btn-warning btn-sm">
    <span>üèÜ</span>
    <span>{{ t('nav.results') }}</span>
</a>
<button onclick="confirmResetBracket('{{ category }}')" class="btn btn-danger btn-sm" title="{{ t('bracket.reset_bracket') }}">
    <span>üîÑ</span>
    <span>{{ t('common.reset') }}</span>
</button>
{% endblock %}

{% block content %}

<!-- Champion Banner (if tournament is complete) -->
{% if champion %}
<div class="card mb-3" style="border: 3px solid #FFD700; box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);">
    <div class="card-body" style="text-align: center; padding: 1.5rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;">
            <span style="font-size: 2rem;">üéâ</span>
            <div>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">{{ t('bracket.tournament_finished') }}</div>
                <div style="font-size: 1.3rem; font-weight: bold;">
                    üëë {{ t('bracket.champion') }}: <span style="color: var(--primary-color);">{{ champion.nombre }} {{ champion.apellido }}</span>
                    <span style="margin-left: 0.5rem;">{{ cc_badge(champion.pais_cd) }}</span>
                </div>
            </div>
            <a href="/category/{{ category }}/results" class="btn btn-warning" style="margin-left: 1rem;">
                {{ t('bracket.view_podium') }} ‚Üí
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Round Display Names Mapping -->
{% set round_names = {
    'R128': t('bracket.round_128'),
    'R64': t('bracket.round_64'),
    'R32': t('bracket.round_32'),
    'R16': t('bracket.round_16'),
    'QF': t('bracket.quarter_finals'),
    'SF': t('bracket.semi_finals'),
    'F': t('bracket.final')
} %}

{% if round_order %}
<!-- Tabs Container -->
<div class="card">
    <div class="card-header" style="padding: 0;">
        <div class="tabs-container">
            {% for round_type in round_order %}
            <button class="tab-button {% if round_type == active_round %}active{% endif %}"
                    data-tab="{{ round_type }}"
                    onclick="switchTab('{{ round_type }}')">
                {{ round_names.get(round_type, round_type) }}
                <span class="tab-badge">{{ matches_by_round[round_type]|length }}</span>
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Tab Content -->
    {% for round_type in round_order %}
    <div class="tab-content {% if round_type == active_round %}active{% endif %}" id="tab-{{ round_type }}">
        <div class="card-body" style="padding: 0;">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>{{ t('matches.player1') }}</th>
                            <th style="width: 40px; text-align: center;">{{ t('matches.vs') }}</th>
                            <th>{{ t('matches.player2') }}</th>
                            <th style="width: 120px; text-align: center;">{{ t('matches.score') }}</th>
                            <th style="width: 120px; text-align: center;">{{ t('tournaments.status') }}</th>
                            <th style="width: 200px; text-align: center;">{{ t('common.actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in matches_by_round[round_type] %}
                        <tr>
                            <td><span class="badge badge-secondary">{{ m.match.match_number }}</span></td>
                            <td>
                                <strong>{{ m.player1.nombre }} {{ m.player1.apellido }}</strong>
                                <span style="margin-left: 0.5rem;">{{ cc_badge(m.player1.pais_cd) }}</span>
                            </td>
                            <td style="text-align: center; color: var(--text-muted);">vs</td>
                            <td>
                                <strong>{{ m.player2.nombre }} {{ m.player2.apellido }}</strong>
                                <span style="margin-left: 0.5rem;">{{ cc_badge(m.player2.pais_cd) }}</span>
                            </td>
                            <td style="text-align: center;">
                                {% if m.match.status == 'WALKOVER' %}
                                    {% if m.match.winner_id == m.player1.id %}
                                        <span class="badge badge-warning">3-0 (WO)</span>
                                    {% else %}
                                        <span class="badge badge-warning">0-3 (WO)</span>
                                    {% endif %}
                                {% elif m.match.status != 'pending' %}
                                    <!-- Calculate sets won for each player -->
                                    {% set p1_sets = namespace(count=0) %}
                                    {% set p2_sets = namespace(count=0) %}
                                    {% for s in m.sets %}
                                        {% if s.player1_points > s.player2_points %}
                                            {% set p1_sets.count = p1_sets.count + 1 %}
                                        {% else %}
                                            {% set p2_sets.count = p2_sets.count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="badge badge-success" style="font-size: 1rem;">{{ p1_sets.count }}-{{ p2_sets.count }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">-</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                {% if m.match.status == 'pending' %}
                                    <span class="badge badge-secondary">{{ t('matches.status.pending') }}</span>
                                {% elif m.match.status == 'in_progress' %}
                                    <span class="badge badge-in-progress">{{ t('matches.status.in_progress') }}</span>
                                {% elif m.match.status == 'WALKOVER' %}
                                    <span class="badge badge-warning">{{ t('matches.status.walkover') }}</span>
                                {% else %}
                                    <span class="badge badge-success">{{ t('matches.status.completed') }}</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <div class="d-flex gap-1" style="justify-content: center;">
                                    {% if is_teams %}
                                        <a href="/team-match/{{ m.match.id }}"
                                           class="btn {% if m.match.status == 'pending' %}btn-success{% else %}btn-warning{% endif %} btn-sm"
                                           title="Encuentro de Equipos"
                                           style="padding: 0.25rem 0.5rem;">
                                            {% if m.match.status == 'pending' %}‚úì{% else %}‚úé{% endif %}
                                        </a>
                                    {% elif m.match.status == 'pending' %}
                                        <a href="/match/{{ m.match.id }}/enter-result"
                                           class="btn btn-success btn-sm"
                                           title="{{ t('matches.enter_result') }}"
                                           style="padding: 0.25rem 0.5rem;">
                                            ‚úì
                                        </a>
                                    {% else %}
                                        <a href="/match/{{ m.match.id }}/enter-result"
                                           class="btn btn-warning btn-sm"
                                           title="{{ t('matches.edit_result') }}"
                                           style="padding: 0.25rem 0.5rem;">
                                            ‚úé
                                        </a>
                                        <form action="/match/{{ m.match.id }}/delete-result" method="post" style="display:inline;" data-confirm="{{ t('matches.confirm_delete') }}">
                                            <button type="submit"
                                                    class="btn btn-danger btn-sm"
                                                    title="{{ t('matches.delete_result') }}"
                                                    style="padding: 0.25rem 0.5rem;">
                                                ‚úï
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <p class="text-muted" style="text-align: center; margin: 2rem 0;">
            {{ t('bracket.no_bracket_matches') }}
        </p>
    </div>
</div>
{% endif %}

<style>
/* In Progress badge animation */
@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
.badge-in-progress {
    background-color: #0d6efd !important;
    color: white !important;
    animation: pulse-badge 1.5s ease-in-out infinite;
}

/* Tabs Container */
.tabs-container {
    display: flex;
    background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
    border-bottom: 2px solid var(--border-color);
    overflow-x: auto;
}

/* Tab Button */
.tab-button {
    flex: 1;
    min-width: 150px;
    padding: 1rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
}

.tab-button:hover {
    background: rgba(33, 150, 243, 0.08);
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: white;
    font-weight: 600;
}

.tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
}

/* Tab Badge */
.tab-badge {
    background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    min-width: 24px;
    text-align: center;
}

.tab-button.active .tab-badge {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
}

/* Tab Content */
.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive */
@media (max-width: 768px) {
    .tab-button {
        min-width: 120px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }

    .tabs-container {
        justify-content: flex-start;
    }
}
</style>

<script>
function switchTab(roundType) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Add active class to selected tab and content
    const selectedButton = document.querySelector(`.tab-button[data-tab="${roundType}"]`);
    const selectedContent = document.getElementById(`tab-${roundType}`);

    if (selectedButton) selectedButton.classList.add('active');
    if (selectedContent) selectedContent.classList.add('active');
}

// Process BYEs confirmation
function confirmProcessByes(category, pendingCount) {
    let message = '{{ t("bracket.process_byes_confirm") }}'.replace('{count}', pendingCount) + '\n\n';
    message += '{{ t("bracket.process_byes_msg") }}\n\n';
    message += '{{ t("bracket.reset_continue") }}';

    if (confirm(message)) {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/bracket/' + category + '/process-byes';
        document.body.appendChild(form);
        form.submit();
    }
}

// Reset bracket confirmation
function confirmResetBracket(category) {
    let message = '{{ t("bracket.reset_confirm_title") }}'.replace('{category}', category) + '\n\n';
    message += '‚ö†Ô∏è {{ t("bracket.reset_warning") }}:\n';
    message += '‚Ä¢ {{ t("bracket.reset_item_1") }}\n';
    message += '‚Ä¢ {{ t("bracket.reset_item_2") }}\n';
    message += '‚Ä¢ {{ t("bracket.reset_item_3") }}\n\n';
    message += '‚úì {{ t("bracket.reset_keep") }}\n\n';
    message += '{{ t("bracket.reset_continue") }}';

    if (confirm(message)) {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/bracket/' + category + '/reset';
        document.body.appendChild(form);
        form.submit();
    }
}

// Clear any saved bracket draft for this category (we're viewing the saved bracket)
localStorage.removeItem('ettem_bracket_draft_{{ category }}');

// Auto-refresh every 10 seconds for live updates
setTimeout(function() {
    window.location.reload();
}, 10000);
</script>

{% endblock %}
