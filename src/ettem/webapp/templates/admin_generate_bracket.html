{% extends "base.html" %}

{% block title %}Generar Bracket - ETTEM{% endblock %}

{% block page_title %}Generar Bracket Eliminatorio{% endblock %}

{% block topbar_actions %}
<a href="/" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>Volver al Inicio</span>
</a>
{% endblock %}

{% block content %}
<!-- Configuration Card -->
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Configuraci√≥n del Bracket</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/admin/generate-bracket/execute" id="bracket-form">
            <div class="grid grid-2 mb-3">
                <div class="form-section">
                    <label class="form-label">Categor√≠a *</label>
                    <select name="category" required class="form-control" id="category-select" onchange="updateQualifiersPreview()">
                        <option value="">-Seleccionar Categor√≠a-</option>
                        {% for cat in available_categories %}
                        <option value="{{ cat.name }}"
                                data-groups="{{ cat.groups }}"
                                data-standings="{{ cat.standings }}"
                                data-has-bracket="{{ 'true' if cat.has_bracket else 'false' }}"
                                data-is-completed="{{ 'true' if cat.is_completed else 'false' }}"
                                {% if cat.is_completed %}style="color: #28a745;"{% elif cat.has_bracket %}style="color: #ffc107;"{% endif %}>
                            {{ cat.name }} ({{ cat.groups }} grupos){% if cat.is_completed %} ‚úÖ COMPLETADO{% elif cat.has_bracket %} ‚ö†Ô∏è tiene bracket{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-section">
                    <label class="form-label">Clasificados por Grupo *</label>
                    <select name="advance_per_group" required class="form-control" id="advance-select" onchange="updateQualifiersPreview()">
                        <option value="1">1er lugar</option>
                        <option value="2" selected>1¬∫ y 2¬∫ lugar (recomendado)</option>
                        <option value="3">1¬∫, 2¬∫ y 3¬∫ lugar</option>
                    </select>
                </div>
            </div>

            <div class="form-section mb-3">
                <label class="form-label">Semilla Aleatoria (Random Seed)</label>
                <input type="number" name="random_seed" class="form-control" placeholder="42" value="42" style="max-width: 200px;">
                <p class="form-help">Para resultados reproducibles en el sorteo de posiciones.</p>
            </div>

            <div class="alert alert-danger mb-3" id="completed-warning" style="display: none;">
                <span class="icon">üö´</span>
                <div class="alert-content">
                    <div class="alert-title">Categor√≠a Completada</div>
                    <div>Esta categor√≠a ya tiene un bracket <strong>COMPLETADO</strong> con campe√≥n declarado. Si regeneras el bracket, perder√°s todos los resultados de la llave eliminatoria.</div>
                </div>
            </div>

            <div class="alert alert-warning mb-3" id="bracket-warning" style="display: none;">
                <span class="icon">‚ö†Ô∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Bracket Existente</div>
                    <div>Esta categor√≠a ya tiene un bracket generado. Si contin√∫as, el bracket actual ser√° <strong>reemplazado</strong> y perder√°s los resultados ingresados.</div>
                </div>
            </div>

            <div class="alert alert-info mb-3" id="qualifiers-info" style="display: none;">
                <span class="icon">‚ÑπÔ∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Vista Previa</div>
                    <div id="qualifiers-text">Selecciona una categor√≠a para ver los clasificados</div>
                </div>
            </div>

            <div class="alert alert-warning mb-3">
                <span class="icon">‚ö†Ô∏è</span>
                <div class="alert-content">
                    <div class="alert-title">Importante</div>
                    <div>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                            <li>Aseg√∫rate de haber calculado las clasificaciones antes de generar el bracket</li>
                            <li>El bracket se genera con el tama√±o de potencia de 2 m√°s cercano (8, 16, 32, etc.)</li>
                            <li>Los primeros de grupo se sortean, los segundos van a mitad opuesta</li>
                            <li>Si ya existe un bracket para esta categor√≠a, se reemplazar√°</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <span>üèÜ</span>
                    <span>Generar Bracket Autom√°tico</span>
                </button>
                <button type="button" class="btn btn-warning" onclick="goToManualBracket()">
                    <span>üéØ</span>
                    <span>Bracket Manual (Drag & Drop)</span>
                </button>
                <a href="/" class="btn btn-secondary">
                    <span>‚úï</span>
                    <span>Cancelar</span>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Standings Preview (if category selected) -->
{% if standings_preview %}
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Clasificaciones de {{ selected_category }}</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Pos</th>
                        <th>Jugador</th>
                        <th>Pts</th>
                        <th>W-L</th>
                        <th>Clasificado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for standing in standings_preview %}
                    <tr {% if standing.qualifies %}style="background-color: var(--success-bg, #d4edda);"{% endif %}>
                        <td><span class="badge badge-secondary">{{ standing.group_name }}</span></td>
                        <td><strong>{{ standing.position }}</strong></td>
                        <td>{{ standing.player_name }}</td>
                        <td>{{ standing.points_total }}</td>
                        <td>{{ standing.wins }}-{{ standing.losses }}</td>
                        <td>
                            {% if standing.qualifies %}
                            <span class="badge badge-success">‚úì S√≠</span>
                            {% else %}
                            <span class="badge badge-secondary">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Existing Brackets (if any) -->
{% if existing_brackets %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Brackets Existentes</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Categor√≠a</th>
                        <th>Tama√±o</th>
                        <th>Jugadores</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bracket in existing_brackets %}
                    <tr {% if bracket.is_completed %}style="background: linear-gradient(90deg, rgba(40, 167, 69, 0.1), transparent);"{% endif %}>
                        <td><span class="badge badge-primary">{{ bracket.category }}</span></td>
                        <td>{{ bracket.size }}</td>
                        <td>{{ bracket.players }}</td>
                        <td>
                            {% if bracket.is_completed %}
                            <span class="badge badge-success">‚úÖ Completado</span>
                            {% else %}
                            <span class="badge badge-warning">üîÑ En progreso</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/bracket/{{ bracket.category }}" class="btn btn-primary btn-sm">
                                <span>üëÅÔ∏è</span>
                                <span>Ver Bracket</span>
                            </a>
                            {% if bracket.is_completed %}
                            <a href="/category/{{ bracket.category }}/results" class="btn btn-success btn-sm">
                                <span>üèÜ</span>
                                <span>Resultados</span>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
function updateQualifiersPreview() {
    const categorySelect = document.getElementById('category-select');
    const advanceSelect = document.getElementById('advance-select');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const qualifiersInfo = document.getElementById('qualifiers-info');
    const qualifiersText = document.getElementById('qualifiers-text');
    const completedWarning = document.getElementById('completed-warning');
    const bracketWarning = document.getElementById('bracket-warning');

    // Hide all warnings first
    completedWarning.style.display = 'none';
    bracketWarning.style.display = 'none';

    if (selectedOption.value) {
        const groups = parseInt(selectedOption.getAttribute('data-groups'));
        const standings = parseInt(selectedOption.getAttribute('data-standings'));
        const advancePerGroup = parseInt(advanceSelect.value);
        const hasBracket = selectedOption.getAttribute('data-has-bracket') === 'true';
        const isCompleted = selectedOption.getAttribute('data-is-completed') === 'true';

        // Show appropriate warning
        if (isCompleted) {
            completedWarning.style.display = 'flex';
        } else if (hasBracket) {
            bracketWarning.style.display = 'flex';
        }

        const totalQualifiers = groups * advancePerGroup;
        const bracketSize = Math.pow(2, Math.ceil(Math.log2(totalQualifiers)));

        let text = `Se clasificar√°n ${totalQualifiers} jugadores (${groups} grupos √ó ${advancePerGroup} clasificados). `;
        text += `El bracket tendr√° tama√±o ${bracketSize}`;
        if (bracketSize > totalQualifiers) {
            text += ` con ${bracketSize - totalQualifiers} BYE(s)`;
        }
        text += `.`;

        qualifiersText.textContent = text;
        qualifiersInfo.style.display = 'flex';
    } else {
        qualifiersInfo.style.display = 'none';
    }
}

function goToManualBracket() {
    const categorySelect = document.getElementById('category-select');
    const selectedCategory = categorySelect.value;

    if (!selectedCategory) {
        alert('Por favor selecciona una categor√≠a primero');
        return;
    }

    window.location.href = `/admin/manual-bracket/${selectedCategory}`;
}
</script>
{% endblock %}
