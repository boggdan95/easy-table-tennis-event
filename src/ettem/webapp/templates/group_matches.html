{% extends "base.html" %}

{% block title %}Partidos Grupo {{ group.name }} - ETTEM{% endblock %}

{% block page_title %}Grupo {{ group.name }} - Partidos{% endblock %}

{% block topbar_actions %}
<a href="/category/{{ category }}" class="btn btn-secondary btn-sm">
    <span>‚Üê</span>
    <span>Volver</span>
</a>
{% endblock %}

{% block content %}
<!-- Navigation Card -->
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex gap-2">
            <a href="/group/{{ group.id }}/standings" class="btn btn-success">
                <span>üìä</span>
                <span>Ver Clasificaci√≥n</span>
            </a>
            <a href="/group/{{ group.id }}/sheet" class="btn btn-secondary">
                <span>üìÑ</span>
                <span>Ver Hoja de Grupo</span>
            </a>
        </div>
    </div>
</div>

<!-- Matches Table Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Lista de Partidos</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 60px;">#</th>
                        <th>Jugador 1</th>
                        <th style="width: 40px; text-align: center;">vs</th>
                        <th>Jugador 2</th>
                        <th style="width: 120px; text-align: center;">Resultado</th>
                        <th style="width: 120px; text-align: center;">Estado</th>
                        <th style="width: 200px; text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in matches %}
                    <tr>
                        <td><span class="badge badge-secondary">{{ m.match.match_number }}</span></td>
                        <td>
                            <strong>{{ m.player1.nombre }} {{ m.player1.apellido }}</strong>
                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ m.player1.pais_cd }}</span>
                        </td>
                        <td style="text-align: center; color: var(--text-muted);">vs</td>
                        <td>
                            <strong>{{ m.player2.nombre }} {{ m.player2.apellido }}</strong>
                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ m.player2.pais_cd }}</span>
                        </td>
                        <td style="text-align: center;">
                            {% if m.match.status == 'WALKOVER' %}
                                {% if m.match.winner_id == m.player1.id %}
                                    <span class="badge badge-warning">3-0 (WO)</span>
                                {% else %}
                                    <span class="badge badge-warning">0-3 (WO)</span>
                                {% endif %}
                            {% elif m.match.status != 'pending' %}
                                <span class="badge badge-success" style="font-size: 1rem;">{{ m.player1_sets }}-{{ m.player2_sets }}</span>
                            {% else %}
                                <span class="badge badge-secondary">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if m.match.status == 'pending' %}
                                <span class="badge badge-secondary">Pendiente</span>
                            {% elif m.match.status == 'WALKOVER' %}
                                <span class="badge badge-warning">Walkover</span>
                            {% else %}
                                <span class="badge badge-success">Completado</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            <div class="d-flex gap-1" style="justify-content: center;">
                                {% if m.match.status == 'pending' %}
                                    <button onclick="openQuickModal({{ m.match.id }}, '{{ m.player1.apellido }}', '{{ m.player2.apellido }}', {{ m.player1.id }}, {{ m.player2.id }})"
                                       class="btn btn-success btn-sm"
                                       title="Ingresar resultado"
                                       style="padding: 0.25rem 0.5rem;">
                                        ‚úì
                                    </button>
                                {% else %}
                                    <a href="/match/{{ m.match.id }}/enter-result"
                                       class="btn btn-warning btn-sm"
                                       title="Editar resultado (detallado)"
                                       style="padding: 0.25rem 0.5rem;">
                                        ‚úé
                                    </a>
                                    <form action="/match/{{ m.match.id }}/delete-result" method="post" style="display:inline;" data-confirm="¬øEst√° seguro de eliminar este resultado?">
                                        <button type="submit"
                                                class="btn btn-danger btn-sm"
                                                title="Eliminar resultado"
                                                style="padding: 0.25rem 0.5rem;">
                                            ‚úï
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Entry Modal -->
<div id="quickModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0;">Ingresar Resultado R√°pido</h3>
        <p id="modalPlayers" style="text-align: center; font-size: 1.1rem; margin: 1rem 0;"></p>

        <form id="quickForm">
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Ganador:</label>
                <select id="modalWinner" class="form-control" required>
                    <option value="">Seleccionar...</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label class="form-label">Score:</label>
                <select id="modalScore" class="form-control" required>
                    <option value="">Seleccionar...</option>
                    <option value="3-0">3-0</option>
                    <option value="3-1">3-1</option>
                    <option value="3-2">3-2</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" onclick="closeQuickModal()" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentMatchId = null;

function openQuickModal(matchId, player1Name, player2Name, player1Id, player2Id) {
    currentMatchId = matchId;

    // Set player names
    document.getElementById('modalPlayers').textContent = `${player1Name} vs ${player2Name}`;

    // Populate winner select
    const winnerSelect = document.getElementById('modalWinner');
    winnerSelect.innerHTML = `
        <option value="">Seleccionar...</option>
        <option value="${player1Id}">${player1Name}</option>
        <option value="${player2Id}">${player2Name}</option>
        <option value="WO-${player1Id}">${player1Name} (WO)</option>
        <option value="WO-${player2Id}">${player2Name} (WO)</option>
    `;

    // Reset form
    document.getElementById('quickForm').reset();

    // Show modal
    document.getElementById('quickModal').style.display = 'flex';
}

function closeQuickModal() {
    document.getElementById('quickModal').style.display = 'none';
    currentMatchId = null;
}

// Handle form submission
document.getElementById('quickForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const winner = document.getElementById('modalWinner').value;
    const score = document.getElementById('modalScore').value;

    if (!winner || !score) {
        showToast('Por favor completa todos los campos', 'warning');
        return;
    }

    const isWalkover = winner.startsWith('WO-');
    const winnerId = isWalkover ? winner.substring(3) : winner;

    try {
        const response = await fetch(`/match/${currentMatchId}/quick-save`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                winner_id: winnerId,
                score: score,
                is_walkover: isWalkover
            })
        });

        const result = await response.json();

        if (response.ok) {
            showToast(result.message || 'Resultado guardado', 'success');
            closeQuickModal();
            // Reload page to show updated results
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(result.error || 'Error al guardar', 'error');
        }
    } catch (error) {
        showToast('Error de conexi√≥n', 'error');
    }
});

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentMatchId) {
        closeQuickModal();
    }
});

// Close modal on background click
document.getElementById('quickModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQuickModal();
    }
});
</script>
{% endblock %}
